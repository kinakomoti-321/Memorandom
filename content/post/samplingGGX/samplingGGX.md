---
title: "SamplingGGX"
date: 2021-08-19T13:10:40+09:00
archives: "2021"
tags: []
author: John SMITH
draft : true
---

# MicroFacetのBRDFの収束が遅い原因
　金属のMicrofacetを実装している際、Lambert反射に比べるとやはり収束が遅いと感じた。特にroughnessが低い（滑らかな）ほど収束が目に見えて遅く、どうにかできないか調べてみた。

　この滑らかな面で収束が遅くなることはサンプリングした$\omega_i$がランダムに取られるため、寄与が少ないパスを取ってしまうことが原因である。金属は基本鏡のように光を反射する鏡面反射を行うため、入射ベクトル$\omega_o$に大して反射方向に強く光を返す性質を持つ。

　roughnessが高い場合、Microfacetの凹凸が激しくそれぞれによって鏡面反射されることで実質的に乱反射のようになるので反射方向以外のパスでもそこそこな寄与を持つことができるのだが、逆にroughnessが低い場合では凹凸はほとんどなく上記の性質のようにある特定への方向付近のパスの寄与が非常に大きくなってくる。そのため、roughnessが低い面では半球一様サンプリング、コサイン重点的サンプリングであると反射方向以外の寄与が低いパスが取られやすく、収束が遅くなるという現象が起きてしまう。つまりはこれをどうにかするにはサンプリングの方法を変えなくてはならないということである。

# GGXの重点的サンプリング
　先輩に相談してみたところ、Microfacetに対する重点的サンプリングが存在しており、以下の資料を教えていただきました。

[A Simpler and Exact Sampling Routine for the GGX Distribution of Visible Normals](https://hal.archives-ouvertes.fr/hal-01509746/document)

　この記事ではGGXの可視法線分布(VNDF)というものを考えて行っているようです。資料によるとHeitz、d'Eonという方がGGX,Beckmann分布における重点的サンプリングを改良しより正確かつシンプルにしたものであるそうです。

　どうやらHeitz,d'Eonによって考案されたサンプリング方法はスロープ空間上（何なのかはわからない）で導出されたもので、ある程度近似が入っているとのこと。これについて、Heitz,d'Eonの手法の詳しい日本語解説記事がありましたので載せておきます。

[Microfacetモデルの重点的サンプリング](https://tatsy.github.io/blog/applications/graphics/1742/)

　これら２つの手法は等価なものなのでpdfは一緒だったりします。この記事では前者の手法について書いていきます。

# アルゴリズム
　この手法では直接反射ベクトル$L$を求めるのではなく、視点ベクトル(View vector)$V$に対して法線ベクトル$N$(以後、サンプリング法線）をサンプリングして、$V$をそのままその$N$に対して鏡面反射させることで$L$を得るという形になります。pdfについては法線分布$D$とハーフベクトル、法線ベクトル（マクロ法線）のなす角$\theta$によって、
$$ pdf = D \cos{\theta} $$
となります。

　ではサンプリング法線を得るアルゴリズムについて書いていきます。まず、$V$から正規直交系を作ります。それぞれの基底ベクトル$ T_1,T_2 $は$V$の外積から
$$ T_1 = normalize(V \times (0,0,1)) $$
$$ T_2 = T_1 \times V $$
と得られます。
　

　次に、z軸のベクトル$Z = (0,0,1)$と$V$の内積(単に$V$のz成分)$z_v = Z \cdot V$から、
$$ a = \frac{1}{1 + z_v} $$
を定義し、一様乱数$u,v = [0,1]$を用いてディスク上の極座標$(r,\phi)$を決定します。$\phi$について訳があることに注意
$$ r = \sqrt{u}$$
$$ \phi = \frac{v}{a} \pi (v < a)$$
$$ \phi = \frac{v-a}{1-a} \pi + \pi (otherwise) $$
この$(r,\phi)$を用いてハーフディスク上のサンプリング位置$P$は
$$ P = r \cos{\phi} T_1 + r \sin{\phi}T_2 (v < a)$$
$$ P = r \cos{\phi} T_1 + r \sin{\phi}z_v T_2 (otherwise)$$
となります。

　この$P$を$V$方向に半球上に射影するとサンプリング法線$N$が得られることとなります。$N$の式は
 $$ N = P + \sqrt{1-|P|^2} V$$
 と得ることができる。

 　異方性があるGGXの場合、これで得られた$N$を
 $$ N = normalize((\alpha_x * x_N,\alpha_y * y_N,max(0.0,z_N))$$
　というベクトルに書き換えてあげる必要があります。
